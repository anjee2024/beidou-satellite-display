# 北斗卫星数据显示系统

## 项目简介

这是一个基于Electron开发的北斗模块串口数据可视化应用，用于实时显示北斗/GPS卫星接收器的各项信息，并提供Modbus TCP Server和NTP Server功能。

## 功能特性

### 1. 串口连接
- 自动检测可用串口设备
- 支持多种波特率配置（4800-115200）
- 实时串口数据接收
- NMEA数据协议解析

### 2. 时间信息
- 显示GPS日期（UTC时间）
- 显示GPS时间（精确到秒）
- 支持时区选择（UTC-12到UTC+12）
- 自动根据选择的时区调整显示时间

### 3. 定位信息
- 实时显示经纬度坐标
- 显示海拔高度（米）
- 定位状态指示（有效/无效）
- 定位质量显示

### 4. 卫星信息
- 可视卫星数量统计
- 卫星天空分布图（天空视图）
  - 圆形视图，中心为天顶（90°）
  - 外圈为地平线（0°）
  - 显示卫星方位角和仰角
  - 根据信号强度用不同颜色表示
- 卫星信号强度条
  - 显示每个卫星的信噪比（SNR）
  - 显示卫星的仰角和方位角
  - 信号强度分级显示（弱/中/强）

### 5. DOP值（精度因子）
- PDOP（位置精度因子）
- HDOP（水平精度因子）
- VDOP（垂直精度因子）

### 6. Modbus TCP Server
- 将北斗数据通过Modbus TCP协议提供给外部系统
- 支持保持寄存器和输入寄存器
- 实时更新北斗定位数据
- 可配置服务端口（默认502）

### 7. NTP Server
- 提供基于北斗/GPS时间的NTP时间同步服务
- 支持可配置时区偏移
- 符合RFC 1305协议标准
- 可配置服务端口（默认123）

### 8. 原始数据
- 实时显示接收到的NMEA原始数据
- 错误信息高亮显示
- 自动滚动到最新数据
- 限制显示行数，避免内存溢出

## 安装与运行

### 1. 安装依赖

```bash
npm install
```

### 2. 运行应用

```bash
npm start
```

## 使用说明

### 1. 连接北斗模块
- 将北斗模块通过USB或串口连接到电脑
- 点击"刷新"按钮获取可用串口列表
- 在"选择串口"下拉框中选择对应的串口
- 设置正确的波特率（默认9600，根据您的模块配置选择）
- 点击"连接"按钮建立连接

#### IP地址选择
在启动Modbus或NTP服务前，系统会自动检测本机所有可用的IPv4地址并显示在下拉框中：
- **外部IP**：如`192.168.x.x`、`10.x.x.x`等，用于局域网内其他设备访问
- **回环地址**：`127.0.0.1`，仅限本机访问

选择您需要绑定的IP地址后，再启动相应的服务。

### 2. 选择时区
- 在"时区设置"面板中选择您所在的时区
- 默认为UTC+8（中国标准时间）
- 系统会自动根据选择的时区调整显示的GPS时间

### 3. 启动Modbus TCP Server
- 在"Modbus TCP服务"面板中选择绑定的IP地址
- 设置端口号（默认502）
- 点击"启动"按钮启动Modbus TCP服务器
- 服务器启动后，可通过Modbus TCP客户端读取北斗数据
- 支持`FC03`（读保持寄存器）和`FC04`（读输入寄存器）功能码
- 点击"查看寄存器数据"按钮可实时查看所有寄存器值

#### ⚠️ Modbus地址说明

**重要：本系统采用 Modbus 协议标准地址（从 1 开始）**

Modbus 协议规范要求寄存器地址从 1 开始，而不是从 0 开始。本系统严格遵循此规范：

- **地址 1**：对应内部索引 0
- **地址 2**：对应内部索引 1
- **地址 N**：对应内部索引 N-1

**读取示例**：
- 读取年份数据：从地址 1 开始，读取 1 个寄存器
- 读取完整日期：从地址 1 开始，读取 3 个寄存器（年、月、日）
- 读取完整时间：从地址 4 开始，读取 3 个寄存器（时、分、秒）

**为什么从 1 开始？**
Modbus 协议（Modbus Application Protocol Specification V1.1b3）明确规定所有寄存器地址都是 1-based 的，这是工业通信领域的标准做法，与某些编程语言的 0-based 数组索引不同。

#### Modbus寄存器地址映射

**保持寄存器 (Holding Registers)**

| 地址 | 数据类型 | 说明 | 格式 |
|------|---------|------|------|
| 1 | UINT16 | 年 (4位) | 2026 |
| 2 | UINT16 | 月 | 1-12 |
| 3 | UINT16 | 日 | 1-31 |
| 4 | UINT16 | 时 (UTC+8) | 0-23 |
| 5 | UINT16 | 分 | 0-59 |
| 6 | UINT16 | 秒 | 0-59 |
| 7 | INT16 | 海拔 (整数部分) | 米 |
| 8 | UINT16 | 海拔 (小数部分) | 精度0.1 |
| 9 | INT16 | 纬度 (整数部分) | 度 |
| 10 | UINT16 | 纬度 (小数部分) | 精度0.000001 |
| 11 | INT16 | 经度 (整数部分) | 度 |
| 12 | UINT16 | 经度 (小数部分) | 精度0.000001 |
| 13 | UINT16 | 卫星数量 | 颗 |
| 14 | UINT16 | 定位质量 | 0-8 |
| 15 | UINT16 | PDOP值 (整数部分) | - |
| 16 | UINT16 | PDOP值 (小数部分) | 精度0.1 |
| 17 | UINT16 | HDOP值 (整数部分) | - |
| 18 | UINT16 | HDOP值 (小数部分) | 精度0.1 |
| 19 | UINT16 | VDOP值 (整数部分) | - |
| 20 | UINT16 | VDOP值 (小数部分) | 精度0.1 |
| 21 | UINT16 | 定位状态 | 0=无效, 1=有效 |
| 22 | INT16 | 时区偏移 | UTC+/-小时 |

**输入寄存器 (Input Registers)**

| 地址 | 数据类型 | 说明 | 格式 |
|------|---------|------|------|
| 1 | UINT32 | 时间戳 | Unix时间戳 |
| 2 | INT16 | 原始海拔值 | 精度0.1 |
| 3 | INT32 | 原始纬度值 | 精度0.0001 |
| 4 | INT32 | 原始经度值 | 精度0.0001 |

#### Modbus使用示例

**Python示例:**
```python
from pymodbus.client import ModbusTcpClient

# 连接到Modbus服务器
client = ModbusTcpClient('127.0.0.1', port=502)
client.connect()

# ⚠️ 注意：Modbus地址从1开始
# 读取保持寄存器 (地址1-3，读取日期：年、月、日)
result = client.read_holding_registers(1, 3)
if not result.isError():
    year = result.registers[0]
    month = result.registers[1]
    day = result.registers[2]
    print(f"日期: {year}-{month:02d}-{day:02d}")

# 读取保持寄存器 (地址4-6，读取时间：时、分、秒)
result = client.read_holding_registers(4, 3)
if not result.isError():
    hour = result.registers[0]
    minute = result.registers[1]
    second = result.registers[2]
    print(f"时间: {hour:02d}:{minute:02d}:{second:02d}")

# 读取海拔值 (地址7-8，整数部分和小数部分)
result = client.read_holding_registers(7, 2)
if not result.isError():
    altitude_int = result.registers[0]
    altitude_dec = result.registers[1]
    altitude = altitude_int + altitude_dec / 10.0
    print(f"海拔: {altitude:.1f} 米")

client.close()
```

**Node.js示例:**
```javascript
const ModbusRTU = require('modbus-serial');

const client = new ModbusRTU();

client.connectTCP('127.0.0.1', { port: 502 })
  .then(() => {
    // ⚠️ 注意：Modbus地址从1开始
    // 读取保持寄存器 (地址1-3，读取日期)
    return client.readHoldingRegisters(1, 3);
  })
  .then(data => {
    console.log('日期:', data.data[0], data.data[1], data.data[2]);
    // 继续读取时间
    return client.readHoldingRegisters(4, 3);
  })
  .then(data => {
    console.log('时间:', data.data.join(':'));
  })
  .then(() => {
    client.close();
  })
  .catch(err => {
    console.error('错误:', err);
  });
```

### 4. 启动NTP Server
- 在"NTP服务"面板中选择绑定的IP地址
- 设置端口号（默认1230，⚠️ 端口123需要管理员权限）
- 选择时区偏移（默认UTC+8）
- 点击"启动"按钮启动NTP服务器
- 服务器启动后，网络中的设备可通过NTP协议同步北斗/GPS时间

#### ⚠️ NTP端口说明
- **端口123**：系统特权端口，需要管理员/root权限，Windows上可能无法绑定
- **端口1230+**：推荐使用的高端口号，无需特殊权限即可使用

#### NTP使用示例

**Windows:**
```cmd
w32tm /stripchart /computer:127.0.0.1 /samples:5
```

**Linux:**
```bash
ntpdate -q 127.0.0.1
# 或使用 chrony
chronyc sources -v
```

**Python测试:**
```python
import ntplib
import time

client = ntplib.NTPClient()
response = client.request('127.0.0.1', port=123)
print(f"时间偏移: {response.offset} 秒")
print(f"往返时间: {response.root_delay} 秒")
print(f"服务器时间: {time.ctime(response.tx_time)}")
```

## 常见问题 (FAQ)

### ⚠️ Modbus地址相关问题

**Q: 为什么从地址 1 开始，而不是从 0 开始？**
A: Modbus 协议规范（Modbus Application Protocol Specification）明确要求寄存器地址从 1 开始，这是工业通信领域的标准。使用地址 0 会导致读取错误的寄存器数据。

**Q: 如何读取完整的日期和时间？**
A:
- 日期：从地址 1 开始，读取 3 个寄存器（年、月、日）
- 时间：从地址 4 开始，读取 3 个寄存器（时、分、秒）

**Q: 如何读取海拔的精确值？**
A: 从地址 7 开始，读取 2 个寄存器：
  - 地址 7：整数部分（米）
  - 地址 8：小数部分（精度 0.1）
  - 实际值 = 整数部分 + 小数部分 / 10

**Q: 如何读取经纬度的精确值？**
A: 纬度从地址 9 开始读取 2 个寄存器，经度从地址 11 开始读取 2 个寄存器：
  - 纬度 = 地址 9 (整数) + 地址 10 (小数) / 1000000
  - 经度 = 地址 11 (整数) + 地址 12 (小数) / 1000000

**Q: 如何读取输入寄存器？**
A: 输入寄存器也从地址 1 开始：
  - 地址 1：Unix 时间戳
  - 地址 2：原始海拔值（精度 0.1）
  - 地址 3：原始纬度值（精度 0.0001）
  - 地址 4：原始经度值（精度 0.0001）

**Q: FC03 和 FC04 有什么区别？**
A:
  - FC03（功能码 03）：读取保持寄存器，地址 1-22
  - FC04（功能码 04）：读取输入寄存器，地址 1-4

**Q: Modbus客户端出现"Message Timeout"或"Insufficient bytes received"错误？**
A: 这通常是响应超时或数据格式问题：
  - **检查网络连接**：确保客户端能正常访问服务器IP和端口
  - **减少请求频率**：避免过于频繁的读取请求（建议间隔≥100ms）
  - **检查响应格式**：使用Wireshark抓包分析Modbus TCP报文格式
  - **查看寄存器数据**：使用本软件的"查看寄存器数据"功能确认数据已更新
  - **字节序问题**：某些客户端可能需要配置字节序（本系统使用标准的大端序）

**Q: 如何实时查看Modbus寄存器值？**
A: 在Modbus服务面板中：
  - 确保Modbus服务器已启动
  - 点击"查看寄存器数据"按钮
  - 弹出对话框显示所有寄存器的实时值
  - 包含保持寄存器（地址1-22）和输入寄存器（地址1-4）
  - 数据每秒自动刷新一次


### 5. 其他问题

**Q: 为什么NTP服务器无法启动，提示端口访问错误？**
A: 这是Windows系统权限限制：
  - **端口123**：系统特权端口，需要管理员权限运行程序
  - **解决方案**：使用高端口号如1230、8080、9000等
  - **推荐**：直接使用默认的1230端口，无需特殊权限

**Q: 为什么服务器启动后立即停止了？**
A: 可能原因：
  - 您点击了"停止"按钮
  - 程序窗口被关闭
  - 端口被其他程序占用
  - 权限不足（特别是端口<1024时）

### 6. 查看数据
- 连接成功后，系统会自动开始接收和解析北斗数据
- 查看主界面的各项数据卡片
- 观察天空视图中的卫星分布
- 查看右侧的卫星信号强度条
- 点击"查看寄存器数据"按钮实时查看Modbus寄存器值

## 技术栈

### 核心技术
- **Electron**: 跨平台桌面应用框架
- **Node.js**: JavaScript运行时环境
- **SerialPort**: Node.js串口通信库
- **原生Net模块**: TCP服务器实现（Modbus TCP）
- **原生dgram模块**: UDP服务器实现（NTP）

### 前端技术
- **HTML5**: 应用界面结构
- **CSS3**: 现代化UI样式设计
- **Canvas API**: 天空视图图形绘制
- **IPC通信**: Electron进程间通信

### 主要依赖
- `electron`: 桌面应用框架
- `serialport`: 串口通信
- `@serialport/parser-readline`: NMEA数据解析
- `modbus-serial`: Modbus协议处理（客户端）

## 支持的NMEA语句

- **GPRMC/GNRMC**: 推荐最小定位信息（时间、日期、位置）
- **GPGGA/GNGGA**: 定位定位数据（海拔、卫星数量、定位质量）
- **GPGSV/BDGSV**: 可视卫星数据（卫星ID、仰角、方位角、信噪比）
- **GPGSA/BDGSA**: 当前卫星数据（DOP值、定位模式）

## 系统要求

- Node.js 14.0 或更高版本
- Windows 10/11, macOS 10.13+, 或 Linux
- 北斗/GPS卫星接收器模块（支持NMEA-0183协议）

## 注意事项

### 硬件连接
1. 确保北斗模块正确连接到电脑
2. 根据您的北斗模块设置正确的波特率（常见9600、115200）
3. 在户外或靠近窗户的地方使用以获得更好的卫星信号
4. 首次连接可能需要几分钟才能获取首次定位（TTFF）

### 网络服务配置
5. **Modbus TCP Server**：默认端口502，可根据需要修改
6. **NTP Server**：默认端口1230（⚠️ 端口123需要管理员权限）
7. 如果端口已被占用，请修改端口号后再启动服务
8. Windows系统需要管理员权限才能使用1024以下的端口
9. 在启动服务前，请先选择要绑定的IP地址

### 数据查看与调试
10. 使用"查看寄存器数据"按钮可实时查看Modbus寄存器值
11. 如果Modbus客户端出现超时，请检查网络连接和请求频率
12. 串口数据会实时更新到Modbus寄存器，确保串口已正确连接

### 应用管理
13. Modbus和NTP服务器会在应用关闭时自动停止
14. 切换IP地址或端口前，请先停止相应的服务
15. 程序运行时请勿删除或修改数据文件

## 服务器配置说明

### Modbus TCP Server

- **默认端口**: 502
- **功能码支持**: FC03 (读保持寄存器), FC04 (读输入寄存器)
- **寄存器类型**: 保持寄存器(地址0-99), 输入寄存器(地址0-99)
- **数据更新频率**: 实时更新（随串口数据接收频率）
- **最大客户端连接数**: 无限制
- **网络协议**: TCP

### NTP Server

- **默认端口**: 123
- **NTP版本**: RFC 1305 (v3)
- **时间精度**: 微秒级
- **层级**: 1 (主时钟)
- **参考标识符**: GPS
- **网络协议**: UDP
- **时区支持**: UTC-12到UTC+12
- **最大并发请求**: 无限制

## 故障排除

### 无法找到串口
- 检查USB驱动是否正确安装
- 尝试更换USB端口
- 检查设备管理器中是否识别到串口设备

### 无法定位
- 确保在户外或信号良好的环境中
- 检查天线连接是否正常
- 等待几分钟让模块搜索卫星

### 显示数据不准确
- 检查时区设置是否正确
- 确认模块是否已成功获取卫星信号
- 查看原始数据确认NMEA语句是否正常

### Modbus服务器无法启动
- 检查端口502是否被其他程序占用
- Windows系统需要管理员权限才能使用1024以下端口
- 检查防火墙设置是否阻止了连接
- 尝试使用其他端口号（如5020、8502等）

### NTP服务器无法启动
- 检查端口123是否被其他NTP服务器占用
- Windows系统需要管理员权限才能使用1024以下端口
- 检查防火墙设置是否阻止了UDP连接
- 尝试使用其他端口号（如1230、8123等）

### 客户端无法连接Modbus服务器
- 检查服务器是否已启动（查看状态指示）
- 确认使用的IP地址和端口号正确
- 检查网络连接和防火墙设置
- 使用telnet或netcat测试端口是否可访问

### 客户端无法同步NTP时间
- 检查NTP服务器是否已启动（查看状态指示）
- 确认使用的IP地址和端口号正确
- 检查防火墙是否阻止了UDP端口123
- 使用ntpdate或其他NTP工具测试连接

## 高级使用

### Modbus数据验证

使用Modbus Poll工具验证数据：
```
地址: 127.0.0.1
端口: 502
功能码: 03
起始地址: 0
寄存器数量: 22
```

### NTP时间同步

配置系统使用本NTP服务器：

**Windows:**
```cmd
w32tm /config /manualpeerlist:"127.0.0.1" /syncfromflags:manual /reliable:no /update
w32tm /resync
```

**Linux (Chrony):**
```
server 127.0.0.1 iburst
```

**Linux (NTPd):**
```
server 127.0.0.1
```

## 性能优化

1. **减少串口数据刷新率**: 如果不需要高频更新，可以降低波特率或减少处理频率
2. **限制Modbus客户端连接**: 虽然支持无限制连接，但实际使用时应根据服务器性能限制并发数
3. **调整寄存器数量**: 根据实际需求使用，避免读取过多寄存器
4. **网络优化**: 在局域网内使用可减少网络延迟和抖动

## 许可证

MIT License
